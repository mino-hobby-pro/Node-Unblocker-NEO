<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Node Unblocker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding:20px; }
    #error { color: red; display:none; margin-bottom:1em; }
  </style>
</head>
<body>
  <h1>Node Unblocker</h1>
  <div id="error"></div>
  <form id="unblocker-form">
    <label>
      URL or Search:
      <input type="text" id="url" autofocus style="width:60%;">
    </label>
    <button type="submit">Go</button>
  </form>

  <h3>About Node Unblocker</h3>
  <p>
    Node Unblocker は、CGIProxy や PHProxy と同様のウェブプロキシです。  
    AES-256-CBC で暗号化された URL を経由して、フィルタや検閲を回避します。
  </p>

  <script>
    const SECRET_KEY_HEX =
      '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef';

    // hex → Uint8Array
    function hexToBytes(hex) {
      const bytes = new Uint8Array(hex.length/2);
      for (let i=0; i<bytes.length; i++) {
        bytes[i] = parseInt(hex.substr(i*2,2), 16);
      }
      return bytes;
    }

    // AES-CBC 暗号化
    async function encryptUrl(plain) {
      const keyBytes = hexToBytes(SECRET_KEY_HEX);
      const key = await crypto.subtle.importKey(
        'raw', keyBytes, { name:'AES-CBC' }, false, ['encrypt']
      );
      const iv = crypto.getRandomValues(new Uint8Array(16));
      const encoded = new TextEncoder().encode(plain);
      const ctBuffer = await crypto.subtle.encrypt(
        { name:'AES-CBC', iv }, key, encoded
      );
      const ctBytes = new Uint8Array(ctBuffer);
      const combined = new Uint8Array(iv.length + ctBytes.length);
      combined.set(iv);
      combined.set(ctBytes, iv.length);

      // Base64
      let bin = '';
      combined.forEach(b => bin += String.fromCharCode(b));
      let b64 = btoa(bin);

      // URL-safe
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    document
      .getElementById('unblocker-form')
      .addEventListener('submit', async e => {
        e.preventDefault();
        let u = document.getElementById('url').value.trim();
        if (!u) return;
        if (!/^https?:\/\//i.test(u)) {
          if (u.includes('.') && !u.includes(' ')) {
            u = 'https://' + u;
          } else {
            u =
              'https://google.com/search?q=' +
              encodeURIComponent(u);
          }
        }
        const enc = await encryptUrl(u);
        window.location.href =
          `${location.protocol}//${location.host}/proxy/${enc}`;
      });

    // URL の ?error=xxx を画面に表示
    function checkError() {
      const p = new URLSearchParams(location.search);
      if (p.has('error')) {
        const e = decodeURIComponent(p.get('error'));
        const el = document.getElementById('error');
        el.textContent = e;
        el.style.display = 'block';
      }
    }
    window.onload = () => {
      document.getElementById('url').focus();
      checkError();
    };
  </script>
</body>
</html>
